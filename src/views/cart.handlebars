{{>navbar}}

<div class="cart-container-all">
   <h1 class="product-d-h1">Cart</h1>

    <table class="cart-table">
        <thead class="cart-thead">
            <tr class="cart-tr">
                <th class="cart-th">imagen</th>
                <th class="cart-th">Producto</th>
                <th class="cart-th">Cantidad</th>
                <th class="cart-th">Precio</th>
                <th class="cart-th">Acciones</th>
            </tr>
        </thead>
        <tbody class="cart-body">
            {{#if products}}
            {{#each products}}
            <tr class="cart-tr">
                {{#each this.img}}
                <td><img src="/img/{{this}}" alt="{{this}}" class="img-cart"></td>
                {{/each}}
                <td>{{this.title}}</td>
                <td>{{this.quantity}}</td>
                <td>{{this.price}}</td>
                <td><button class="btn-delete-product active-btn" onclick="deleteProductFromCart('{{this._id}}')"><img src="https://cdn-icons-png.flaticon.com/512/39/39220.png" class="icon-delete-img" /></button></td>
            </tr>
            {{/each}}

            {{else}}
                <tr>
                    <td>El carrito está vacio</td>
                </tr>
            {{/if}}
            
        </tbody>
    </table>
    <div class="container-go-products">
        <a href="/products" class="btn-send-msg btn-go-products">Go to Products</a>
        <button class="btn-send-msg btn-go-products" onclick="generateTicket('{{cart_id}}')">Generar Ticket</button>
    </div>
    

  
  
</section>
   
</div> 
{{>footer}} 
<script>
  function generateTicket(cart_id) {
    // Realiza la solicitud para generar el ticket
    const cid = cart_id
    console.log('cid', cid)
    /*fetch(`/api/carts/${cid}/purchase`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
       body: JSON.stringify({}) 
    })
      .then(response => response.json())
      .then(data => {
        // Maneja la respuesta de la solicitud
        //console.log("Ticket generado:", data.ticket);
        //console.log('ticket type, ', typeof data.ticket._id)
        // Redirecciona a la página del ticket generado
        window.location.href = `/api/ticket/${data.ticket._id}`;
      })
      .catch(error => {
        console.error("Error al generar el ticket:", error);
      });*/
  }

  async function deleteProductFromCart(pid) {
    const currentURL = window.location.href;
    const cartID = currentURL.split('/').pop();
    console.log('ID del producto:', pid);
    console.log('ID del carrito:', cartID);
    const url = `/api/carts/${cartID}/products/${pid}`;

    const response = await fetch(url, {
      method: 'DELETE'
    });

    if(response.ok){
      window.location.reload(); //recarga la página
    }
  }
</script>

